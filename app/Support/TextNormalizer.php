<?php

declare(strict_types=1);

namespace App\Support;

/**
 * テキスト正規化ユーティリティ
 *
 * 全銀フォーマット用の文字列正規化を提供
 */
class TextNormalizer
{
    /**
     * 全角カタカナを半角カタカナに変換
     *
     * @param  string  $str  変換対象文字列
     * @return string 半角カタカナに変換された文字列
     */
    public static function toHalfWidthKana(string $str): string
    {
        // 全角→半角変換マップ
        $map = [
            'ア' => 'ｱ', 'イ' => 'ｲ', 'ウ' => 'ｳ', 'エ' => 'ｴ', 'オ' => 'ｵ',
            'カ' => 'ｶ', 'キ' => 'ｷ', 'ク' => 'ｸ', 'ケ' => 'ｹ', 'コ' => 'ｺ',
            'サ' => 'ｻ', 'シ' => 'ｼ', 'ス' => 'ｽ', 'セ' => 'ｾ', 'ソ' => 'ｿ',
            'タ' => 'ﾀ', 'チ' => 'ﾁ', 'ツ' => 'ﾂ', 'テ' => 'ﾃ', 'ト' => 'ﾄ',
            'ナ' => 'ﾅ', 'ニ' => 'ﾆ', 'ヌ' => 'ﾇ', 'ネ' => 'ﾈ', 'ノ' => 'ﾉ',
            'ハ' => 'ﾊ', 'ヒ' => 'ﾋ', 'フ' => 'ﾌ', 'ヘ' => 'ﾍ', 'ホ' => 'ﾎ',
            'マ' => 'ﾏ', 'ミ' => 'ﾐ', 'ム' => 'ﾑ', 'メ' => 'ﾒ', 'モ' => 'ﾓ',
            'ヤ' => 'ﾔ', 'ユ' => 'ﾕ', 'ヨ' => 'ﾖ',
            'ラ' => 'ﾗ', 'リ' => 'ﾘ', 'ル' => 'ﾙ', 'レ' => 'ﾚ', 'ロ' => 'ﾛ',
            'ワ' => 'ﾜ', 'ヲ' => 'ｦ', 'ン' => 'ﾝ',
            'ガ' => 'ｶﾞ', 'ギ' => 'ｷﾞ', 'グ' => 'ｸﾞ', 'ゲ' => 'ｹﾞ', 'ゴ' => 'ｺﾞ',
            'ザ' => 'ｻﾞ', 'ジ' => 'ｼﾞ', 'ズ' => 'ｽﾞ', 'ゼ' => 'ｾﾞ', 'ゾ' => 'ｿﾞ',
            'ダ' => 'ﾀﾞ', 'ヂ' => 'ﾁﾞ', 'ヅ' => 'ﾂﾞ', 'デ' => 'ﾃﾞ', 'ド' => 'ﾄﾞ',
            'バ' => 'ﾊﾞ', 'ビ' => 'ﾋﾞ', 'ブ' => 'ﾌﾞ', 'ベ' => 'ﾍﾞ', 'ボ' => 'ﾎﾞ',
            'パ' => 'ﾊﾟ', 'ピ' => 'ﾋﾟ', 'プ' => 'ﾌﾟ', 'ペ' => 'ﾍﾟ', 'ポ' => 'ﾎﾟ',
            'ァ' => 'ｧ', 'ィ' => 'ｨ', 'ゥ' => 'ｩ', 'ェ' => 'ｪ', 'ォ' => 'ｫ',
            'ッ' => 'ｯ', 'ャ' => 'ｬ', 'ュ' => 'ｭ', 'ョ' => 'ｮ',
            'ー' => 'ｰ', '、' => '､', '。' => '｡', '・' => '･',
            '「' => '｢', '」' => '｣', '゛' => 'ﾞ', '゜' => 'ﾟ',
            '　' => ' ', // 全角スペース→半角スペース
        ];

        // ひらがな→カタカナ変換マップ
        $hiraganaToKatakana = [
            'あ' => 'ア', 'い' => 'イ', 'う' => 'ウ', 'え' => 'エ', 'お' => 'オ',
            'か' => 'カ', 'き' => 'キ', 'く' => 'ク', 'け' => 'ケ', 'こ' => 'コ',
            'さ' => 'サ', 'し' => 'シ', 'す' => 'ス', 'せ' => 'セ', 'そ' => 'ソ',
            'た' => 'タ', 'ち' => 'チ', 'つ' => 'ツ', 'て' => 'テ', 'と' => 'ト',
            'な' => 'ナ', 'に' => 'ニ', 'ぬ' => 'ヌ', 'ね' => 'ネ', 'の' => 'ノ',
            'は' => 'ハ', 'ひ' => 'ヒ', 'ふ' => 'フ', 'へ' => 'ヘ', 'ほ' => 'ホ',
            'ま' => 'マ', 'み' => 'ミ', 'む' => 'ム', 'め' => 'メ', 'も' => 'モ',
            'や' => 'ヤ', 'ゆ' => 'ユ', 'よ' => 'ヨ',
            'ら' => 'ラ', 'り' => 'リ', 'る' => 'ル', 'れ' => 'レ', 'ろ' => 'ロ',
            'わ' => 'ワ', 'を' => 'ヲ', 'ん' => 'ン',
            'が' => 'ガ', 'ぎ' => 'ギ', 'ぐ' => 'グ', 'げ' => 'ゲ', 'ご' => 'ゴ',
            'ざ' => 'ザ', 'じ' => 'ジ', 'ず' => 'ズ', 'ぜ' => 'ゼ', 'ぞ' => 'ゾ',
            'だ' => 'ダ', 'ぢ' => 'ヂ', 'づ' => 'ヅ', 'で' => 'デ', 'ど' => 'ド',
            'ば' => 'バ', 'び' => 'ビ', 'ぶ' => 'ブ', 'べ' => 'ベ', 'ぼ' => 'ボ',
            'ぱ' => 'パ', 'ぴ' => 'ピ', 'ぷ' => 'プ', 'ぺ' => 'ペ', 'ぽ' => 'ポ',
            'ぁ' => 'ァ', 'ぃ' => 'ィ', 'ぅ' => 'ゥ', 'ぇ' => 'ェ', 'ぉ' => 'ォ',
            'っ' => 'ッ', 'ゃ' => 'ャ', 'ゅ' => 'ュ', 'ょ' => 'ョ',
            'ゎ' => 'ヮ',
        ];

        // 1. ひらがな→カタカナ
        $str = str_replace(array_keys($hiraganaToKatakana), array_values($hiraganaToKatakana), $str);

        // 2. 全角カタカナ→半角カタカナ
        $str = str_replace(array_keys($map), array_values($map), $str);

        // 3. 全角英数を半角に（0-9, A-Z, a-z）
        $str = mb_convert_kana($str, 'as', 'UTF-8');

        return $str;
    }

    /**
     * 禁止文字を許可された文字に置換
     *
     * @param  string  $str  置換対象文字列
     * @return string 置換後の文字列
     */
    public static function replaceProhibited(string $str): string
    {
        $map = config('zengin.prohibited_map', []);

        return str_replace(array_keys($map), array_values($map), $str);
    }

    /**
     * 制御文字を除去
     *
     * @param  string  $str  除去対象文字列
     * @return string 制御文字を除去した文字列
     */
    public static function removeControlCharacters(string $str): string
    {
        // タブと改行以外の制御文字を除去
        return preg_replace('/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/u', '', $str);
    }

    /**
     * 全銀フォーマット用に文字列をサニタイズ
     *
     * @param  string  $str  サニタイズ対象文字列
     * @return string サニタイズ後の文字列
     */
    public static function sanitizeForZengin(string $str): string
    {
        // 1. 制御文字除去
        $str = self::removeControlCharacters($str);

        // 2. 禁止文字置換
        $str = self::replaceProhibited($str);

        // 3. 半角カナ化
        $str = self::toHalfWidthKana($str);

        // 4. トリム
        $str = trim($str);

        return $str;
    }
}

