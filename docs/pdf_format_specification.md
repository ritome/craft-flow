# PDFフォーマット仕様書

**ドキュメント名**: POSレジPDFフォーマット仕様  
**バージョン**: 1.0.0  
**作成日**: 2025-11-15  
**対象**: POSレジ出力PDF（岩手県センター）

---

## 目次

1. [概要](#1-概要)
2. [PDFフォーマット詳細](#2-pdfフォーマット詳細)
3. [データ抽出仕様](#3-データ抽出仕様)
4. [パース処理の実装方針](#4-パース処理の実装方針)
5. [エッジケースと例外処理](#5-エッジケースと例外処理)
6. [テストデータ](#6-テストデータ)

---

## 1. 概要

### 1.1 目的

POSレジから出力されるPDFファイルのフォーマット仕様を定義し、自動パース処理の基盤とする。

### 1.2 対象レジ

- **レジ台数**: 4台
- **レジ番号**: POS1, POS2, POS3, POS4
- **フォーマット**: 全レジ共通フォーマット（4台すべて同一）
- **商品数**: 常に30品目（固定）
- **ページ数**: 単一ページ（複数ページになることはない）

### 1.3 出力頻度

- **日次**: 営業終了後に1日分のデータを出力
- **営業日と出力日時**: 通常は異なる日付（営業終了後に翌日出力）だが、同日の場合もある

---

## 2. PDFフォーマット詳細

### 2.1 全体構造

PDFは以下の3つのセクションで構成される：

```
┌─────────────────────────────────────┐
│  ヘッダーセクション                   │
│  - レジ番号                          │
│  - 営業日                            │
│  - 出力日時                          │
├─────────────────────────────────────┤
│  商品データセクション（2カラム表示）   │
│  - 商品コード                        │
│  - 商品名                            │
│  - 単価                              │
│  - 数量                              │
│  - 小計                              │
├─────────────────────────────────────┤
│  フッターセクション                   │
│  - 合計金額                          │
└─────────────────────────────────────┘
```

### 2.2 ヘッダーセクション

#### 2.2.1 レジ番号

**フォーマット**:
```
レジ番号:POS[1-4]
```

**パターン**:
- `レジ番号:POS1`
- `レジ番号:POS2`
- `レジ番号:POS3`
- `レジ番号:POS4`

**抽出正規表現**:
```regex
レジ番号:POS(\d+)
```

**データ型**: `string`  
**サンプル値**: `POS1`

---

#### 2.2.2 営業日

**フォーマット**:
```
営業日:令和[元号年]年[月]月[日]日
```

**パターン例**:
- `営業日:令和7年11月5日`
- `営業日:令和7年1月1日`

**抽出正規表現**:
```regex
営業日:令和(\d+)年(\d+)月(\d+)日
```

**データ型**: `string` → `date` に変換  
**変換ロジック**: 令和年を西暦に変換（令和元年 = 2019年）  
**サンプル値**: `2025-11-05`

**変換テーブル**:
| 令和 | 西暦 |
|------|------|
| 元年 | 2019 |
| 2年 | 2020 |
| 3年 | 2021 |
| 4年 | 2022 |
| 5年 | 2023 |
| 6年 | 2024 |
| 7年 | 2025 |

---

#### 2.2.3 出力日時

**フォーマット**:
```
出力日時:令和[元号年]年[月]月[日]日 [時]時[分]分
```

**パターン例**:
- `出力日時:令和7年11月6日 17時30分`

**抽出正規表現**:
```regex
出力日時:令和(\d+)年(\d+)月(\d+)日\s+(\d+)時(\d+)分
```

**データ型**: `string` → `datetime` に変換  
**サンプル値**: `2025-11-06 17:30:00`

---

### 2.3 商品データセクション

#### 2.3.1 レイアウト

商品データは**2カラム形式**で表示される：

```
商品コード 商品名 単価 数量 小計 | 商品コード 商品名 単価 数量 小計
P001 南部鉄器 急須(小) ¥8,500 1 ¥8,500 | P016 わら細工 鍋敷き ¥800 0 ¥0
```

**重要**: 
- 左カラムと右カラムは空白またはタブで区切られる
- 各行に2商品分のデータが含まれる
- 数量が0の商品も含まれる（在庫管理用）

#### 2.3.2 商品コード

**フォーマット**: `P[3桁数字]`

**パターン例**:
- `P001`, `P002`, ..., `P030`

**データ型**: `string`  
**桁数**: 4桁固定（P + 3桁数字）

#### 2.3.3 商品名

**フォーマット**: 日本語文字列（スペース、括弧含む）

**特徴**:
- 漢字、ひらがな、カタカナを含む
- 括弧 `()` で詳細情報を含む場合がある
  - 例: `南部鉄器 急須(小)`, `南部せんべい(10枚入・ごま)`

**データ型**: `string`  
**最大文字数**: 不明（実データから推定: 30文字程度）

**サンプル**:
- `南部鉄器 急須(小)`
- `南部せんべい(10枚入・ごま)`
- `盛岡冷麺(2食入・スープ付)`
- `ホームスパン コースター(4枚組)`

#### 2.3.4 単価

**フォーマット**: `¥[金額]`

**特徴**:
- 通貨記号 `¥` が先頭に付く
- 3桁ごとにカンマ `,` で区切られる
- 小数点なし（円単位）

**パターン例**:
- `¥8,500`
- `¥650`
- `¥15,000`

**抽出正規表現**:
```regex
¥([\d,]+)
```

**データ型**: `string` → `integer` に変換  
**変換**: カンマを削除して整数化  
**サンプル値**: `8500`, `650`, `15000`

#### 2.3.5 数量

**フォーマット**: 半角数字

**パターン例**:
- `0`, `1`, `2`, `3`, `5`

**データ型**: `integer`  
**範囲**: 0以上の整数

**注意**:
- **数量0の商品も含まれる**（在庫管理・カタログ表示用）
- 集計時は数量0の商品を除外する

#### 2.3.6 小計

**フォーマット**: `¥[金額]`

**計算式**:
```
小計 = 単価 × 数量
```

**特徴**:
- 単価と同じフォーマット（`¥` + カンマ区切り）
- 数量0の場合は `¥0`

**パターン例**:
- `¥8,500` (¥8,500 × 1)
- `¥9,600` (¥3,200 × 3)
- `¥0` (¥800 × 0)

**データ型**: `string` → `integer` に変換  
**サンプル値**: `8500`, `9600`, `0`

---

### 2.4 フッターセクション

#### 2.4.1 合計金額

**フォーマット**:
```
合計 ¥[金額]
```

**計算式**:
```
合計 = Σ(小計) ※数量0を含む全商品
```

**パターン例**:
- `合計 ¥89,910`

**抽出正規表現**:
```regex
合計\s+¥([\d,]+)
```

**データ型**: `string` → `integer` に変換  
**サンプル値**: `89910`

---

## 3. データ抽出仕様

### 3.1 抽出対象データ

| No | 項目名 | データ型 | 必須 | 備考 |
|----|--------|---------|------|------|
| 1 | レジ番号 | string | ○ | POS1〜POS4 |
| 2 |営業日 | date | ○ | 令和→西暦変換 |
| 3 | 出力日時 | datetime | △ | 参考情報 |
| 4 | 商品コード | string | ○ | P + 3桁数字 |
| 5 | 商品名 | string | ○ | 日本語 |
| 6 | 単価 | integer | ○ | 円単位 |
| 7 | 数量 | integer | ○ | 0以上 |
| 8 | 小計 | integer | ○ | 単価×数量 |
| 9 | 合計金額 | integer | ○ | 全商品小計の合計 |

### 3.2 抽出後のデータ構造

#### JSON形式

```json
{
  "register_id": "POS1",
  "business_date": "2025-11-05",
  "output_datetime": "2025-11-06 17:30:00",
  "items": [
    {
      "product_code": "P001",
      "product_name": "南部鉄器 急須(小)",
      "unit_price": 8500,
      "quantity": 1,
      "subtotal": 8500
    },
    {
      "product_code": "P002",
      "product_name": "南部鉄器 風鈴",
      "unit_price": 3200,
      "quantity": 3,
      "subtotal": 9600
    }
    // ... 以下、全商品
  ],
  "total": 89910
}
```

#### PHP配列形式

```php
[
    'register_id' => 'POS1',
    'business_date' => '2025-11-05',
    'output_datetime' => '2025-11-06 17:30:00',
    'items' => [
        [
            'product_code' => 'P001',
            'product_name' => '南部鉄器 急須(小)',
            'unit_price' => 8500,
            'quantity' => 1,
            'subtotal' => 8500,
        ],
        [
            'product_code' => 'P002',
            'product_name' => '南部鉄器 風鈴',
            'unit_price' => 3200,
            'quantity' => 3,
            'subtotal' => 9600,
        ],
        // ... 以下、全商品
    ],
    'total' => 89910,
]
```

---

## 4. パース処理の実装方針

### 4.1 パース処理フロー

```
[PDFテキスト]
    │
    ▼
[1. ヘッダー抽出]
    │ - レジ番号
    │ - 営業日
    │ - 出力日時
    ▼
[2. 商品データ抽出]
    │ - 2カラム形式を1行ずつ処理
    │ - 各商品の5項目を抽出
    ▼
[3. フッター抽出]
    │ - 合計金額
    ▼
[4. データ検証]
    │ - 小計の計算チェック
    │ - 合計金額の整合性チェック
    ▼
[5. データ構造化]
    │ - 配列/DTOに変換
    ▼
[抽出完了]
```

### 4.2 正規表現パターン一覧

#### ヘッダー部分

```php
// レジ番号
$registerPattern = '/レジ番号:POS(\d+)/u';

// 営業日
$businessDatePattern = '/営業日:令和(\d+)年(\d+)月(\d+)日/u';

// 出力日時
$outputDatetimePattern = '/出力日時:令和(\d+)年(\d+)月(\d+)日\s+(\d+)時(\d+)分/u';
```

#### 商品データ部分

**2カラム形式の行パターン**:
```php
$itemLinePattern = '/(P\d{3})\s+(.+?)\s+¥([\d,]+)\s+(\d+)\s+¥([\d,]+)\s+(P\d{3})\s+(.+?)\s+¥([\d,]+)\s+(\d+)\s+¥([\d,]+)/u';
```

**単一カラムパターン（予備）**:
```php
$singleItemPattern = '/(P\d{3})\s+(.+?)\s+¥([\d,]+)\s+(\d+)\s+¥([\d,]+)/u';
```

#### フッター部分

```php
// 合計金額
$totalPattern = '/合計\s+¥([\d,]+)/u';
```

### 4.3 データ変換処理

#### 4.3.1 令和年→西暦変換

```php
function convertReiwaToAD(int $reiwaYear): int
{
    // 令和元年 = 2019年
    return 2018 + $reiwaYear;
}

// 例: 令和7年 → 2025年
```

#### 4.3.2 日付文字列→Date変換

```php
function parseBusinessDate(int $reiwaYear, int $month, int $day): string
{
    $year = convertReiwaToAD($reiwaYear);
    return sprintf('%04d-%02d-%02d', $year, $month, $day);
}

// 例: (7, 11, 5) → "2025-11-05"
```

#### 4.3.3 日時文字列→DateTime変換

```php
function parseOutputDatetime(
    int $reiwaYear, 
    int $month, 
    int $day, 
    int $hour, 
    int $minute
): string {
    $year = convertReiwaToAD($reiwaYear);
    return sprintf(
        '%04d-%02d-%02d %02d:%02d:00', 
        $year, $month, $day, $hour, $minute
    );
}

// 例: (7, 11, 6, 17, 30) → "2025-11-06 17:30:00"
```

#### 4.3.4 金額文字列→整数変換

```php
function parsePrice(string $priceString): int
{
    // "¥8,500" → 8500
    $cleaned = str_replace(['¥', ','], '', $priceString);
    return (int) $cleaned;
}
```

### 4.4 データ検証ロジック

#### 4.4.1 小計の検証

```php
function validateSubtotal(int $unitPrice, int $quantity, int $subtotal): bool
{
    return ($unitPrice * $quantity) === $subtotal;
}
```

#### 4.4.2 合計金額の検証

```php
function validateTotal(array $items, int $total): bool
{
    $calculatedTotal = array_sum(array_column($items, 'subtotal'));
    return $calculatedTotal === $total;
}
```

---

## 5. エッジケースと例外処理

### 5.1 想定されるエッジケース

| ケース | 説明 | 対応方針 |
|--------|------|---------|
| **数量0の商品** | 商品は存在するが販売実績なし | 含めて抽出するが、集計時は除外 |
| **商品名の空白** | 商品名に複数の空白が含まれる | トリムして正規化 |
| **高額商品** | 単価が100万円以上 | 通常処理（カンマ処理で対応） |
| **大量購入** | 数量が3桁以上 | 通常処理 |
| **0円商品** | 単価が0円 | サンプル品として許容 |
| **部分的な破損** | 一部の商品データが欠損 | その行をスキップし、ログ記録 |
| **営業日=出力日時** | 同日に出力される場合 | 通常処理（日付が異なることを前提としない） |

**注意**: 
- ❌ **改ページ対応は不要**（常に単一ページ）
- ✅ **商品数は常に30品目**（固定値として検証可能）

### 5.2 例外処理

#### パースエラー

```php
// ヘッダー情報が取得できない
throw new InvalidArgumentException('レジ番号が取得できませんでした');

// 商品データが1つも取得できない
throw new RuntimeException('商品データが見つかりませんでした');

// 合計金額の不一致
Log::warning('合計金額が一致しません', [
    'calculated' => $calculatedTotal,
    'pdf_total' => $total,
]);
```

#### データ不整合

```php
// 小計の計算が合わない
Log::warning('小計の計算が一致しません', [
    'product_code' => $item['product_code'],
    'unit_price' => $item['unit_price'],
    'quantity' => $item['quantity'],
    'subtotal' => $item['subtotal'],
]);
```

---

## 6. テストデータ

### 6.1 サンプルPDFデータ

#### POS1（サンプル提供データ）

```
レジ番号:POS1
営業日:令和7年11月5日
出力日時:令和7年11月6日 17時30分

商品コード 商品名 単価 数量 小計 商品コード 商品名 単価 数量 小計
P001 南部鉄器 急須(小) ¥8,500 1 ¥8,500 P016 わら細工 鍋敷き ¥800 0 ¥0
P002 南部鉄器 風鈴 ¥3,200 3 ¥9,600 P017 わら細工 壁掛け飾り ¥2,000 2 ¥4,000
P003 南部鉄器 文鎮 ¥1,800 0 ¥0 P018 ホームスパン マフラー ¥15,000 1 ¥15,000
P004 南部せんべい(10枚入・ごま) ¥650 0 ¥0 P019 ホームスパン コースター(4枚組) ¥2,800 0 ¥0
P005 南部せんべい(10枚入・ピーナッツ) ¥650 1 ¥650 P020 盛岡冷麺(2食入・スープ付) ¥800 3 ¥2,400
P006 南部せんべい(10枚入・りんご) ¥750 2 ¥1,500 P021 盛岡冷麺(4食入・スープ付) ¥1,500 5 ¥7,500
P007 藍染ハンカチ ¥1,500 3 ¥4,500 P022 手作りクッキー詰合せ ¥1,200 2 ¥2,400
P008 藍染手ぬぐい ¥2,200 0 ¥0 P023 手作りジャム(りんご) ¥850 0 ¥0
P009 藍染トートバッグ ¥4,800 1 ¥4,800 P024 手作りジャム(ブルーベリー) ¥900 0 ¥0
P010 南部焼 湯呑み ¥2,800 1 ¥2,800 P025 木工品 お盆(中) ¥3,200 3 ¥9,600
P011 南部焼 飯椀 ¥2,500 2 ¥5,000 P026 木工品 箸置き(5個セット) ¥1,500 0 ¥0
P012 南部焼 マグカップ ¥3,500 0 ¥0 P027 螺鈿細工 ブローチ ¥6,500 1 ¥6,500
P013 竹細工 箸(5膳セット) ¥1,200 1 ¥1,200 P028 螺鈿細工 ペンダント ¥8,800 0 ¥0
P014 竹細工 弁当箱 ¥4,500 0 ¥0 P029 郷土玩具 チャグチャグ馬コ(小) ¥1,800 1 ¥1,800
P015 竹細工 茶托(5枚組) ¥3,800 0 ¥0 P030 岩手銘菓 かもめの玉子(8個入) ¥1,080 2 ¥2,160

合計 ¥89,910
```

### 6.2 期待される抽出結果

#### 基本情報

```php
[
    'register_id' => 'POS1',
    'business_date' => '2025-11-05',
    'output_datetime' => '2025-11-06 17:30:00',
    'total' => 89910,
]
```

#### 商品データ（数量 > 0のみ）

| 商品コード | 商品名 | 単価 | 数量 | 小計 |
|-----------|--------|------|------|------|
| P001 | 南部鉄器 急須(小) | 8,500 | 1 | 8,500 |
| P002 | 南部鉄器 風鈴 | 3,200 | 3 | 9,600 |
| P005 | 南部せんべい(10枚入・ピーナッツ) | 650 | 1 | 650 |
| P006 | 南部せんべい(10枚入・りんご) | 750 | 2 | 1,500 |
| P007 | 藍染ハンカチ | 1,500 | 3 | 4,500 |
| P009 | 藍染トートバッグ | 4,800 | 1 | 4,800 |
| P010 | 南部焼 湯呑み | 2,800 | 1 | 2,800 |
| P011 | 南部焼 飯椀 | 2,500 | 2 | 5,000 |
| P013 | 竹細工 箸(5膳セット) | 1,200 | 1 | 1,200 |
| P017 | わら細工 壁掛け飾り | 2,000 | 2 | 4,000 |
| P018 | ホームスパン マフラー | 15,000 | 1 | 15,000 |
| P020 | 盛岡冷麺(2食入・スープ付) | 800 | 3 | 2,400 |
| P021 | 盛岡冷麺(4食入・スープ付) | 1,500 | 5 | 7,500 |
| P022 | 手作りクッキー詰合せ | 1,200 | 2 | 2,400 |
| P025 | 木工品 お盆(中) | 3,200 | 3 | 9,600 |
| P027 | 螺鈿細工 ブローチ | 6,500 | 1 | 6,500 |
| P029 | 郷土玩具 チャグチャグ馬コ(小) | 1,800 | 1 | 1,800 |
| P030 | 岩手銘菓 かもめの玉子(8個入) | 1,080 | 2 | 2,160 |

**合計**: ¥89,910

---

## 7. その他の仕様

### 7.1 フォーマットバリエーション

**確定情報**:
- ✅ **4台すべてのレジで同一フォーマット**（POS1〜POS4）
- ✅ レジ番号のみが異なる（POS1, POS2, POS3, POS4）
- ✅ フォーマット変更の予定なし

**将来の拡張**:
- 異なるフォーマットが追加される場合は、`ParserFactory` で判定ロジックを拡張

### 7.2 文字エンコーディング

- **PDF内**: PDF内部エンコーディング（通常UTF-8）
- **抽出後**: UTF-8
- **日本語対応**: 必須

### 7.3 商品マスタ

**確定情報**:
- ✅ **商品数は常に30品目**（固定）
- ✅ 商品コード: P001〜P030
- ✅ 数量0の商品も必ず含まれる（全30品目が毎回出力される）

**検証ロジック**:
- PDFから抽出される商品データ（数量0を含む）が30品目であることを検証可能
- 30品目未満の場合はデータ欠損として警告

### 7.4 ページ構成

**確定情報**:
- ✅ **常に単一ページ**（複数ページになることはない）
- ✅ 改ページ処理は不要
- ✅ 商品数30品目は1ページに収まる設計

### 7.5 営業日と出力日時の関係

**確定情報**:
- 📝 通常は**営業日 < 出力日時**（営業終了後、翌日に出力）
- 📝 ただし、**同日の場合もある**（営業日 = 出力日時の日付）
- ⚠️ 営業日が出力日時より未来になることはない想定

---

## 8. 更新履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|-------|
| 2025-11-15 | 1.0.0 | 初版作成（POS1サンプルデータを基に作成） | - |

---

**END OF DOCUMENT**

