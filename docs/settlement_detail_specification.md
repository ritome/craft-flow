# 📋 精算書明細の表示仕様

## 作成日
2025-11-21

## 仕様の概要

委託販売精算書の商品明細は、**各売上レコードを個別に表示**する仕様です。

## 表示ルール

### 1. 基本方針

売上データの各レコードを、そのまま精算書の明細行として表示します。

**重要:** 同じ商品コードであっても、売上レコードが異なる場合は別の行として表示されます。

### 2. 表示例

#### 売上データ（入力）

```
日付,委託先ID,商品コード,商品名,単価,販売数,売上金額
2025-10-01,C001,P001,南部鉄器 急須(小),8500,3,25500
2025-10-05,C001,P002,南部鉄器 風鈴,3200,8,25600
2025-10-10,C001,P003,南部鉄器 文鎮,1800,5,9000
2025-10-15,C001,P001,南部鉄器 急須(小),8500,4,34000
2025-10-20,C001,P002,南部鉄器 風鈴,3200,7,22400
2025-10-25,C001,P003,南部鉄器 文鎮,1800,3,5400
```

#### 精算書の明細（出力）

```
【精算期間】 2025年10月1日 ～ 2025年10月31日

商品コード | 商品名              | 単価    | 販売数 | 売上金額
----------|---------------------|---------|--------|----------
P001      | 南部鉄器 急須(小)   | 8,500   | 3      | 25,500
P002      | 南部鉄器 風鈴       | 3,200   | 8      | 25,600
P003      | 南部鉄器 文鎮       | 1,800   | 5      | 9,000
P001      | 南部鉄器 急須(小)   | 8,500   | 4      | 34,000
P002      | 南部鉄器 風鈴       | 3,200   | 7      | 22,400
P003      | 南部鉄器 文鎮       | 1,800   | 3      | 5,400

小計                                              121,900
委託販売手数料(20%)                               -24,380
消費税(10%)                                         9,752
振込手数料                                           -440
─────────────────────────────────────────────────────
お支払金額                                        106,832
```

### 3. 仕様の理由

この仕様により、以下のメリットがあります：

1. **販売履歴の透明性**
   - いつ、何個売れたかが明確にわかる
   - 販売日ごとの追跡が可能

2. **データの正確性**
   - 元の売上データと精算書の整合性が保たれる
   - データの加工による誤差がない

3. **監査の容易性**
   - 売上データと精算書を照合しやすい
   - 問題があった場合の原因特定が容易

## 集計ルール

### 合計金額の計算

個別の売上レコードの金額を単純に合計します。

```
小計 = Σ(各レコードの売上金額)
```

### 手数料の計算

```
委託販売手数料 = 小計 × 手数料率（通常20%）
消費税 = (小計 - 委託販売手数料) × 消費税率（10%）
お支払金額 = 小計 - 委託販売手数料 + 消費税 - 振込手数料
```

## 実装詳細

### データフロー

```
売上Excelファイル
    ↓
[売上レコード読み込み]
    ↓
[期間フィルタリング]
    ↓
[委託先別にグループ化]
    ↓
[各レコードを明細配列に追加] ← ここで個別レコードとして保存
    ↓
[金額集計]
    ↓
精算書生成
```

### コード実装（SettlementService.php）

```php
// 売上明細に手数料率を追加して保存（個別レコードとして）
$sale['commission_rate'] = $commissionRate;
$settlementData[$clientCode]['sales_details'][] = $sale;
```

**重要ポイント:**
- `$sale` レコードをそのまま配列に追加
- 商品コードでの集約は行わない
- 各売上レコードが個別の明細行になる

## 別の仕様との比較

### 商品統合方式（不採用）

商品コード別に集約する方式も考えられますが、本システムでは採用していません。

#### 統合方式の例

```
商品コード | 商品名              | 単価    | 販売数 | 売上金額
----------|---------------------|---------|--------|----------
P001      | 南部鉄器 急須(小)   | 8,500   | 7      | 59,500
P002      | 南部鉄器 風鈴       | 3,200   | 15     | 48,000
P003      | 南部鉄器 文鎮       | 1,800   | 8      | 14,400
```

#### 不採用の理由

1. **販売履歴が失われる**
   - いつ何個売れたかの情報が不明になる

2. **単価が異なる場合の処理が複雑**
   - 同じ商品で価格変更があった場合の対応が困難

3. **元データとの照合が困難**
   - 売上Excelと精算書の突合が難しい

## テストケース

### 正常系

1. **同じ商品コードが複数回出現する場合**
   - 期待値: それぞれ個別の行として表示される

2. **異なる日付の売上レコード**
   - 期待値: すべてのレコードが表示される

3. **商品コードが1つだけの場合**
   - 期待値: 1行のみ表示される

### 異常系

1. **売上レコードが0件の場合**
   - 期待値: 明細なしで合計0円

2. **商品コードが欠落している場合**
   - 期待値: 商品コード空欄で表示

## 関連ファイル

- `app/Services/SettlementService.php` - 精算計算ロジック
- `app/Exports/SettlementExcelExport.php` - Excel出力
- `app/Exports/SettlementPdfExport.php` - PDF出力
- `resources/views/settlements/pdf.blade.php` - PDFテンプレート

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2025-11-21 | 初版作成 - 個別レコード表示の仕様を明文化 | AI Assistant |

---

**作成日:** 2025-11-21  
**最終更新:** 2025-11-21  
**ステータス:** ✅ 確定

