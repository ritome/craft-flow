# Excel出力仕様書

**ドキュメント名**: 売上集計Excel出力仕様  
**バージョン**: 1.0.0  
**作成日**: 2025-11-15  
**対象**: 4台のPOSレジデータ集計結果

---

## 目次

1. [概要](#1-概要)
2. [ファイル仕様](#2-ファイル仕様)
3. [シート構成](#3-シート構成)
4. [各シートの詳細](#4-各シートの詳細)
5. [スタイリング仕様](#5-スタイリング仕様)
6. [実装方針](#6-実装方針)

---

## 1. 概要

### 1.1 目的

4台のPOSレジから抽出したデータを集計し、見やすいExcel形式で出力する。

### 1.2 出力タイミング

- PDFファイルアップロード後、即座に生成
- ユーザーがブラウザから直接ダウンロード

### 1.3 対象データ

- 入力: 4台のレジPDFファイル（1〜4ファイル）
- 出力: 1つの集計Excelファイル

---

## 2. ファイル仕様

### 2.1 ファイル形式

- **形式**: Excel 2007以降（.xlsx）
- **エンコーディング**: UTF-8
- **ライブラリ**: `maatwebsite/excel` (Laravel Excel)

### 2.2 ファイル名

**命名規則**:
```
売上集計_{営業日}_{タイムスタンプ}.xlsx
```

**例**:
```
売上集計_2025-11-05_20251106173000.xlsx
```

**フォーマット**:
- `{営業日}`: YYYY-MM-DD形式
- `{タイムスタンプ}`: YYYYMMDDHHmmss形式（ファイル生成日時）

### 2.3 保存場所

- **一時保存**: `storage/app/exports/`
- **保存期間**: 24時間（バッチで自動削除）
- **履歴保存**: オプションでデータベースにパスを保存

---

## 3. シート構成

Excelファイルは以下の**3シート**で構成される：

| シート番号 | シート名 | 説明 |
|-----------|---------|------|
| 1 | **集計サマリー** | 全体の合計と各レジの小計 |
| 2 | **商品別集計** | 商品ごとの販売数量・金額集計 |
| 3 | **レジ別詳細** | 各レジの詳細データ（全商品） |

---

## 4. 各シートの詳細

### 4.1 シート1: 集計サマリー

#### 4.1.1 目的

全体の売上概要を一目で把握できるようにする。

#### 4.1.2 レイアウト

```
+----------------------------------------------------------------------+
|                      売上集計サマリー                                  |
|                     営業日: 2025年11月5日                             |
+----------------------------------------------------------------------+
|                                                                      |
| レジ番号 | 処理日時              | 販売商品数 | 販売数量合計 | 売上金額     |
|----------------------------------------------------------------------+
| POS1    | 2025-11-06 17:30:00   |     18    |     35      | ¥89,910   |
| POS2    | 2025-11-06 17:32:00   |     15    |     28      | ¥76,500   |
| POS3    | 2025-11-06 17:35:00   |     20    |     42      | ¥105,200  |
| POS4    | 2025-11-06 17:40:00   |     12    |     22      | ¥58,300   |
|----------------------------------------------------------------------+
| 合計    |                       |     65    |    127      | ¥329,910  |
+----------------------------------------------------------------------+
|                                                                      |
| 【補足情報】                                                          |
| ・処理ファイル数: 4ファイル                                            |
| ・処理成功: 4ファイル                                                 |
| ・処理失敗: 0ファイル                                                 |
| ・ファイル生成日時: 2025-11-06 18:00:00                               |
+----------------------------------------------------------------------+
```

#### 4.1.3 カラム定義

| カラム | 型 | 説明 | 例 |
|--------|---|------|-----|
| レジ番号 | string | レジID | POS1 |
| 処理日時 | datetime | PDF出力日時 | 2025-11-06 17:30:00 |
| 販売商品数 | integer | 数量>0の商品種類数 | 18 |
| 販売数量合計 | integer | 全商品の数量合計 | 35 |
| 売上金額 | integer | 小計の合計（円） | 89,910 |

#### 4.1.4 セル範囲

- **タイトル**: A1:E1（結合セル）
- **営業日**: A2:E2（結合セル）
- **ヘッダー**: A4:E4
- **データ行**: A5:E8（レジ4台分）
- **合計行**: A9:E9
- **補足情報**: A11:E15

---

### 4.2 シート2: 商品別集計

#### 4.2.1 目的

どの商品がどれだけ売れたかを商品単位で把握する。

#### 4.2.2 レイアウト

```
+--------------------------------------------------------------------------------+
|                            商品別販売集計                                        |
|                          営業日: 2025年11月5日                                  |
+--------------------------------------------------------------------------------+
|                                                                                |
| 商品コード | 商品名                          | 単価    | 販売数量 | 売上金額      |
|--------------------------------------------------------------------------------+
| P001      | 南部鉄器 急須(小)                | ¥8,500  |    3    | ¥25,500     |
| P002      | 南部鉄器 風鈴                    | ¥3,200  |    8    | ¥25,600     |
| P005      | 南部せんべい(10枚入・ピーナッツ)  | ¥650    |    5    | ¥3,250      |
| ...       | ...                             | ...     | ...     | ...         |
|--------------------------------------------------------------------------------+
| 合計      |                                 |         |   127   | ¥329,910    |
+--------------------------------------------------------------------------------+
|                                                                                |
| ※ 数量0の商品は含まれていません                                                  |
+--------------------------------------------------------------------------------+
```

#### 4.2.3 カラム定義

| カラム | 型 | 説明 | 例 |
|--------|---|------|-----|
| 商品コード | string | 商品ID | P001 |
| 商品名 | string | 商品名称 | 南部鉄器 急須(小) |
| 単価 | integer | 商品単価 | 8,500 |
| 販売数量 | integer | 全レジでの合計販売数 | 3 |
| 売上金額 | integer | 単価×販売数量 | 25,500 |

#### 4.2.4 集計ロジック

```
販売数量 = Σ(各レジの数量) ※レジ1〜4
売上金額 = 単価 × 販売数量
```

#### 4.2.5 ソート順

- **第1キー**: 売上金額の降順（売れ筋商品が上位）
- **第2キー**: 商品コードの昇順

#### 4.2.6 セル範囲

- **タイトル**: A1:E1（結合セル）
- **営業日**: A2:E2（結合セル）
- **ヘッダー**: A4:E4
- **データ行**: A5:E{n}（商品数に応じて可変）
- **合計行**: A{n+1}:E{n+1}
- **注釈**: A{n+3}:E{n+3}

---

### 4.3 シート3: レジ別詳細

#### 4.3.1 目的

各レジの詳細データを確認する。トラブルシューティングや詳細分析に使用。

#### 4.3.2 レイアウト

```
+-----------------------------------------------------------------------------------+
|                              レジ別販売詳細                                         |
|                           営業日: 2025年11月5日                                    |
+-----------------------------------------------------------------------------------+
|                                                                                   |
| レジ番号 | 商品コード | 商品名                  | 単価    | 数量 | 小計           |
|-----------------------------------------------------------------------------------+
| POS1    | P001      | 南部鉄器 急須(小)        | ¥8,500  |  1   | ¥8,500        |
| POS1    | P002      | 南部鉄器 風鈴            | ¥3,200  |  3   | ¥9,600        |
| POS1    | P005      | 南部せんべい(10枚入...)  | ¥650    |  1   | ¥650          |
| ...     | ...       | ...                     | ...     | ...  | ...           |
|-----------------------------------------------------------------------------------+
| POS1 小計                                                        |  35  | ¥89,910      |
|-----------------------------------------------------------------------------------+
| POS2    | P001      | 南部鉄器 急須(小)        | ¥8,500  |  2   | ¥17,000       |
| ...     | ...       | ...                     | ...     | ...  | ...           |
|-----------------------------------------------------------------------------------+
| POS2 小計                                                        |  28  | ¥76,500      |
|-----------------------------------------------------------------------------------+
| ...                                                                               |
|-----------------------------------------------------------------------------------+
| 総合計                                                           | 127  | ¥329,910     |
+-----------------------------------------------------------------------------------+
|                                                                                   |
| ※ 数量0の商品は含まれていません                                                     |
+-----------------------------------------------------------------------------------+
```

#### 4.3.3 カラム定義

| カラム | 型 | 説明 | 例 |
|--------|---|------|-----|
| レジ番号 | string | レジID | POS1 |
| 商品コード | string | 商品ID | P001 |
| 商品名 | string | 商品名称 | 南部鉄器 急須(小) |
| 単価 | integer | 商品単価 | 8,500 |
| 数量 | integer | 販売数量 | 1 |
| 小計 | integer | 単価×数量 | 8,500 |

#### 4.3.4 ソート順

- **第1キー**: レジ番号の昇順（POS1 → POS2 → POS3 → POS4）
- **第2キー**: 商品コードの昇順

#### 4.3.5 セル範囲

- **タイトル**: A1:F1（結合セル）
- **営業日**: A2:F2（結合セル）
- **ヘッダー**: A4:F4
- **データ行**: A5:F{n}（レジ×商品数に応じて可変）
- **レジ小計行**: レジごとに挿入
- **総合計行**: 最下部

---

## 5. スタイリング仕様

### 5.1 フォント

- **基本フォント**: メイリオ（日本語）、Arial（英数字）
- **フォントサイズ**:
  - タイトル: 14pt、太字
  - ヘッダー: 11pt、太字
  - データ行: 11pt、通常
  - 合計行: 11pt、太字

### 5.2 セルの配置

| 要素 | 水平方向 | 垂直方向 |
|------|---------|---------|
| タイトル | 中央揃え | 中央揃え |
| ヘッダー | 中央揃え | 中央揃え |
| 文字列（レジ番号、商品名） | 左揃え | 中央揃え |
| 数値（単価、数量、金額） | 右揃え | 中央揃え |
| 合計行 | 右揃え | 中央揃え |

### 5.3 罫線

- **外枠**: 太線（黒）
- **ヘッダー下**: 太線（黒）
- **データ行**: 細線（グレー）
- **合計行上**: 太線（黒）

### 5.4 背景色

| 要素 | 背景色 | 文字色 |
|------|--------|-------|
| タイトル | 濃い青（#1F4E78） | 白 |
| ヘッダー | 薄い青（#D9E2F3） | 黒 |
| データ行（奇数） | 白 | 黒 |
| データ行（偶数） | 薄いグレー（#F2F2F2） | 黒 |
| 合計行 | 黄色（#FFF2CC） | 黒（太字） |
| レジ小計行 | 薄い黄色（#FFF9E6） | 黒（太字） |

### 5.5 数値フォーマット

| 項目 | フォーマット | 例 |
|------|-------------|-----|
| 金額（円） | `#,##0` | 89,910 |
| 数量 | `0` | 35 |
| 日付 | `yyyy-mm-dd` | 2025-11-05 |
| 日時 | `yyyy-mm-dd hh:mm:ss` | 2025-11-06 17:30:00 |

### 5.6 列幅

| シート | カラム | 幅（文字数） |
|-------|--------|------------|
| 集計サマリー | レジ番号 | 10 |
| 集計サマリー | 処理日時 | 20 |
| 集計サマリー | 販売商品数 | 12 |
| 集計サマリー | 販売数量合計 | 12 |
| 集計サマリー | 売上金額 | 15 |
| 商品別集計 | 商品コード | 12 |
| 商品別集計 | 商品名 | 35 |
| 商品別集計 | 単価 | 12 |
| 商品別集計 | 販売数量 | 12 |
| 商品別集計 | 売上金額 | 15 |
| レジ別詳細 | レジ番号 | 10 |
| レジ別詳細 | 商品コード | 12 |
| レジ別詳細 | 商品名 | 30 |
| レジ別詳細 | 単価 | 12 |
| レジ別詳細 | 数量 | 8 |
| レジ別詳細 | 小計 | 15 |

---

## 6. 実装方針

### 6.1 使用ライブラリ

**maatwebsite/excel** (Laravel Excel)

```bash
composer require maatwebsite/excel
```

### 6.2 実装クラス

#### 6.2.1 Exportクラス構成

```php
app/
└── Exports/
    ├── SalesExport.php                  // メインエクスポートクラス
    ├── Sheets/
    │   ├── SummarySheet.php             // シート1: 集計サマリー
    │   ├── ProductAggregationSheet.php  // シート2: 商品別集計
    │   └── RegisterDetailSheet.php      // シート3: レジ別詳細
    └── Concerns/
        └── StyleHelper.php              // スタイル共通処理
```

#### 6.2.2 SalesExport実装例

```php
namespace App\Exports;

use Maatwebsite\Excel\Concerns\WithMultipleSheets;

class SalesExport implements WithMultipleSheets
{
    public function __construct(
        private readonly array $aggregatedData
    ) {}

    public function sheets(): array
    {
        return [
            new SummarySheet($this->aggregatedData),
            new ProductAggregationSheet($this->aggregatedData),
            new RegisterDetailSheet($this->aggregatedData),
        ];
    }
}
```

### 6.3 データ構造（入力）

Exportクラスに渡される `$aggregatedData` の構造：

```php
[
    'business_date' => '2025-11-05',
    'generated_at' => '2025-11-06 18:00:00',
    'file_count' => 4,
    'success_count' => 4,
    'failed_count' => 0,
    
    // レジ別データ
    'registers' => [
        [
            'register_id' => 'POS1',
            'output_datetime' => '2025-11-06 17:30:00',
            'items' => [
                [
                    'product_code' => 'P001',
                    'product_name' => '南部鉄器 急須(小)',
                    'unit_price' => 8500,
                    'quantity' => 1,
                    'subtotal' => 8500,
                ],
                // ...
            ],
            'product_count' => 18,  // 販売商品数（数量>0）
            'quantity_total' => 35, // 販売数量合計
            'sales_total' => 89910, // 売上金額合計
        ],
        // POS2, POS3, POS4...
    ],
    
    // 商品別集計データ
    'products' => [
        [
            'product_code' => 'P001',
            'product_name' => '南部鉄器 急須(小)',
            'unit_price' => 8500,
            'total_quantity' => 3,  // 全レジ合計数量
            'total_sales' => 25500, // 全レジ合計売上
        ],
        // ...
    ],
    
    // 全体サマリー
    'summary' => [
        'total_product_types' => 65,   // 販売商品種類数合計
        'total_quantity' => 127,       // 販売数量合計
        'total_sales' => 329910,       // 売上金額合計
    ],
]
```

### 6.4 スタイリング実装

#### WithStyles トレイト使用

```php
use Maatwebsite\Excel\Concerns\WithStyles;
use PhpOffice\PhpSpreadsheet\Worksheet\Worksheet;

public function styles(Worksheet $sheet): array
{
    return [
        // タイトル行
        1 => [
            'font' => [
                'bold' => true,
                'size' => 14,
                'color' => ['rgb' => 'FFFFFF'],
            ],
            'fill' => [
                'fillType' => \PhpOffice\PhpSpreadsheet\Style\Fill::FILL_SOLID,
                'color' => ['rgb' => '1F4E78'],
            ],
            'alignment' => [
                'horizontal' => \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_CENTER,
            ],
        ],
        
        // ヘッダー行
        4 => [
            'font' => ['bold' => true],
            'fill' => [
                'fillType' => \PhpOffice\PhpSpreadsheet\Style\Fill::FILL_SOLID,
                'color' => ['rgb' => 'D9E2F3'],
            ],
        ],
    ];
}
```

### 6.5 エクスポート実行

#### Controllerでの使用例

```php
use App\Exports\SalesExport;
use Maatwebsite\Excel\Facades\Excel;

public function download(array $aggregatedData): Response
{
    $fileName = $this->generateFileName($aggregatedData['business_date']);
    
    return Excel::download(
        new SalesExport($aggregatedData),
        $fileName
    );
}

private function generateFileName(string $businessDate): string
{
    $timestamp = now()->format('YmdHis');
    return "売上集計_{$businessDate}_{$timestamp}.xlsx";
}
```

---

## 7. テスト仕様

### 7.1 単体テスト

- 各Sheetクラスのデータ生成テスト
- スタイリング適用テスト
- 数値フォーマットテスト

### 7.2 統合テスト

- Excelファイル生成テスト
- ファイルダウンロードテスト
- データ整合性チェック

### 7.3 手動テスト

- Excelファイルを実際に開いて確認
- 各シートのレイアウト確認
- 数値の正確性確認

---

## 8. 今後の拡張

### 8.1 グラフ追加

- 商品別売上グラフ（棒グラフ）
- レジ別売上比較グラフ（円グラフ）
- 時系列推移グラフ（折れ線グラフ）

### 8.2 フィルター機能

- オートフィルター機能の追加
- 並べ替え機能

### 8.3 条件付き書式

- 売上上位商品を強調表示
- 売上目標達成状況を色分け

---

## 9. 更新履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|-------|
| 2025-11-15 | 1.0.0 | 初版作成 | - |

---

**END OF DOCUMENT**

